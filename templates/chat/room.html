{% load static %}
<!DOCTYPE html>
<html class=''>
  <head>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    {% comment %} <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script> {% endcomment %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <meta charset='UTF-8'>
    <meta name="robots" content="noindex">
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600,700,300' rel='stylesheet' type='text/css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css'>
    <link rel='stylesheet prefetch' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css'>
    <link rel="stylesheet" href="{% static 'style.css' %}" />
  </head>
  <body>
    <div id="frame">
      <div id="sidepanel">
        <div id="profile">
          <div class="wrap">
            <img id="profile-img" src="http://emilcarlsson.se/assets/mikeross.png" class="online" alt="" />
            <p>{{ user }}</p>
            <a href="/api-auth/logout/?next=/chat/" class="expand-button" style="color: #fff; float: right;">Logout</a>

          </div>
        </div>
        <div id="search">
          <label for="">
          <i class="fa fa-search" aria-hidden="true"></i>
          </label>
          <input type="text" placeholder="Search contacts..." />
        </div>
        <div id="contacts">
          <ul>
          {% for room in rooms %}
            <li class="contact" onclick="changeRoom({{room.id}})">
              <div class="wrap">
                <img src="https://www.appiyus.com/wp-content/uploads/2016/04/chat-2-icon.png" alt="" />
                <div class="meta">
                  <p class="name">{{ room.name }}</p>
                  <p class="preview">{{ room.latest_message }}</p>
                </div>
              </div>
            </li>
          {% endfor %}
          </ul>
        </div>
        <div id="bottom-bar">
          <button id="addcontact">
          <i class="fa fa-user-plus fa-fw" aria-hidden="true"></i>
          <span>Add contact</span>
          </button>
          <button id="settings">
          <i class="fa fa-cog fa-fw" aria-hidden="true"></i>
          <span>Settings</span>
          </button>
        </div>
      </div>
      <div class="content">
        <div class="contact-profile">
          <img src="https://www.appiyus.com/wp-content/uploads/2016/04/chat-2-icon.png" alt="" />
          <p id="room-name"></p>
        </div>
        <div class="messages">
          <ul id="chat-logs">
          </ul>
        </div>
        <div class="message-input">
          <div class="wrap" id="wrap-message">
            <input id="chat-message-input" type="text" placeholder="Write your message..." />
            <i class="fa fa-paperclip attachment" aria-hidden="true"></i>
            <button id="chat-message-submit" class="submit">
            <i class="fa fa-paper-plane" aria-hidden="true"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{% static 'reconnecting-websocket.js' %}"></script>
    <script>

      var chatSocket = new WebSocket(
      'ws://' + window.location.host + '/ws' + window.location.pathname);

      var username = '{{user.username}}'
      var userId = '{{user.id}}'
      var room = {};
      var roomUsers = [];
      var rooms = '{{rooms}}';

      chatSocket.onopen = function(e) {
        fetchData();
      }

      chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var command = data.command;
        var message = data.message;

        console.log(data);

        if (command === 'fetch_data') {

          room = data.room.fields;
          roomUsers = data.room_users;

          var roomUserText = '';

          for (let i = 0; i < roomUsers.length; i++) {
            roomUserText += roomUsers[i].fields.username + ((i < roomUsers.length - 1) ? ' | ' : '');
          }

          // Update room name
          $('#room-name').text(room.name + ' - ' + roomUserText)

          for (let i = 0; i < data.messages.length; i++) {
            createMessage(data['messages'][i]);
          }
        } else if (command === 'new_message') {
          createMessage(message);
        } else if (command === 'error_message') {
          alert('Error: ' + message);
        }
      };

      chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
        };

        document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // enter, return
          document.querySelector('#chat-message-submit').click();
        }
      };

      document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = $('#chat-message-input');
        var message = messageInputDom.val() && messageInputDom.val().trim();

        if (message) {
          chatSocket.send(JSON.stringify({
            'command': 'new_message',
            'message': message
          }));

          messageInputDom.val('');
        }
      };

      function fetchData() {
        chatSocket.send(JSON.stringify({'command': 'fetch_data'}));
      }

      function createMessage(data) {

        // Format data
        data = data.fields

        var author_id = data.user;
        var msgListTag = document.createElement('li');
        var imgTag = document.createElement('img');
        var msgTag = document.createElement('p');
        var usernameTag = document.createElement('span');
        usernameTag.textContent = data.user.username;
        msgTag.textContent = data.message;
        imgTag.src = 'https://png.pngtree.com/svg/20161027/631929649c.svg';

        if (Number(author_id) === Number(userId)) {
          msgListTag.className = 'sent';
        } else {
          msgListTag.className = 'replies';
        }

        msgListTag.appendChild(imgTag);
        msgListTag.appendChild(usernameTag);
        msgListTag.appendChild(msgTag);
        document.querySelector('#chat-logs').appendChild(msgListTag);
      }

      function changeRoom(room) {
        var href = window.location.origin + '/chat/' + room ;
        window.location.href = href;
      }

    </script>
  </body>
</html>
